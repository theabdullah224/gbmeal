@app.route('/generate', methods=['OPTIONS', 'POST'])
def generate_meal_plan():
    if request.method == 'OPTIONS':
        response = jsonify({})
        response.headers.add('Access-Control-Allow-Origin', '*')
        response.headers.add('Access-Control-Allow-Headers', 'Content-Type')
        return response

    try:
        html_template = """
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>{title}</title>
        </head>
        <body>
            <img src="https://www.gbmeals.com/static/media/logo2.2cc494b3c43bf1131ac7.png" 
                 alt="Logo" 
                 style="display: block; margin: 10px auto; width: 100px; height: auto;" />
            {content}
        </body>
        </html>
        """
        
      
        for i in range(servings):
            prompt = ( """)

        response = client.chat.completions.create(
            model="gpt-4o-2024-08-06",
            messages=[
                {
                    "role": "system",
                    "content": (
                        f"""
You are a meal planning assistant. Provide the meal plan in HTML format only, with no additional commentary. The plan should be for {servings} servings, where each (total serving's) total calories must  equals to {total_calories} for example the servings are {servings} and demanding calories are {total_calories} so you have to design the meal plan as where the total sevings/meals calories should be equal to the {total_calories}. Design a balanced meal plan that includes lean protein, healthy fats, whole grains, and vegetables. Each recipe should list precise ingredient measurements to meet the calorie goal. Ensure a good macronutrient balance in each dish, with a clear calorie breakdown per meal and per ingredient where possible.
"""

                        f"Ensure the meal plan consists of exactly {servings} meals, each corresponding to one serving. "
                        "Follow the provided structure and do not include any additional information, headers, or categories like 'breakfast' or 'lunch'. "
                        "Avoid using escape characters such as '\\n' or '\\'. Only use the specified HTML tags."
                    )
                },
                {"role": "user", "content": prompt}
            ],
        )
        
        meal_plan_content = response.choices[0].message.content.replace('```html', '').replace('```', '').strip()
        
        
        # Split content at the shopping list header
        split_marker = '<h1>Weekly Shopping List</h1>'
        parts = meal_plan_content.split(split_marker)

        # Generate meal plan PDF
        meal_plan_html = html_template.replace("{content}", parts[0]).replace("{title}", "Meal Plan")
        meal_plan_pdf = pdfkit.from_string(meal_plan_html, False, configuration=config)
        meal_plan_base64 = base64.b64encode(meal_plan_pdf).decode('utf-8')

        # Generate shopping list PDF
        shopping_list_html = html_template.replace("{content}", split_marker + parts[1]).replace("{title}", "Shopping List")
        shopping_list_pdf = pdfkit.from_string(shopping_list_html, False, configuration=config)
        shopping_list_base64 = base64.b64encode(shopping_list_pdf).decode('utf-8')




        return jsonify({
            "meal_plan_pdf": meal_plan_base64,
            "shopping_list_pdf": shopping_list_base64
        })
        
    except Exception as e:
        error_message = str(e)
        logging.error('Error generating response: %s', error_message)
        return jsonify({"error": error_message}), 500

